# P2 金融 LLM 壓力測試：反事實微擾與雜訊敏感度分析
# Stress Testing Financial LLMs: Counterfactual Perturbation and Noise Sensitivity Analysis on CFA Examinations

> **狀態**：✅ 論文已完成 | **頁數**：17 | **樣本量**：N=100 | **目標期刊**：Finance Research Letters (FRL)
> **論文資料夾**：`drafts/selected/I1_counterfactual/`
> **合併自**：I1（反事實壓力測試）+ I3（雜訊與紅鯡魚）

---

## 研究背景與問題

LLM 在 CFA benchmark 上的高準確率可能是假象。CFA 題庫有限、結構固定、SchweserNotes 等準備材料在網路上大量流通——模型在預訓練時很可能已「見過」這些題目。因此「答對」可能只是 **memorization** 而非 **reasoning**。

此外，真實金融工作充滿雜訊——20 頁的 earnings call 可能只有 3 段是關鍵資訊、分析報告夾雜冗長免責聲明。但現有基準都使用乾淨的題目文本，完全不測試模型在噪音環境下的表現。

本研究提出**雙維度壓力測試框架**：
1. **I1 反事實微擾**：改變題目中的數值或條件，測試模型是否真正理解 vs 只是背答案
2. **I3 雜訊注入**：在題目中加入無關資訊、誤導干擾、冗餘上下文，測試資訊過濾能力

---

## 核心方法

### 方法一覽

**I1：反事實微擾（Counterfactual Perturbation）**

兩層微擾設計：
- **Level 1（數值替換）**：改變數值參數（利率 5%→7%），保持解題邏輯不變。模型需在新數值下重新計算。
- **Level 2（條件改變）**：改變前提條件（annual→continuous compounding, call→put option）。模型需切換推理路徑。

核心指標：
- `Memorization Gap = 原題準確率 − 微擾題準確率`（正值 = 記憶化依賴）
- `Robust Accuracy = 原題 + 所有微擾都答對才計分`

**I3：雜訊注入（Noise Injection）**

四類雜訊：
- **N1（無關數據）**：插入看似相關但無關的數值（如 Bond pricing 題加入「員工人數」）
- **N2（誤導性干擾）**：插入表面相關但實際會誤導推理的文字
- **N3（冗餘上下文）**：模擬真實報告的冗長格式
- **N4（矛盾資訊）**：前後文資訊矛盾

核心指標：`Noise Sensitivity Index (NSI) = (acc_clean − acc_noisy) / acc_clean`

---

### 用一個例子理解

#### 原始題目

> A company's stock has a beta of 1.2. The risk-free rate is 3%, and the market risk premium is 8%. Using CAPM, the expected return is closest to:
> - (A) 12.6%
> - (B) 11.0%
> - (C) 9.6%

正解：E(R) = 3% + 1.2 × 8% = **12.6%** → (A)。模型答對了。

#### I1 反事實微擾

**Level 1（數值替換）**：把 beta 從 1.2 改成 0.8，其他不變。

> ...beta of **0.8**. Risk-free rate 3%, market risk premium 8%...

新正解：E(R) = 3% + 0.8 × 8% = **9.4%**。

如果模型真懂 CAPM，換個數字照算就好。但如果模型只是「記住了 beta=1.2 配 12.6%」這個搭配，換了數字就會卡住或重複輸出 12.6%。

**Level 2（條件改變）**：把 CAPM 改成 Fama-French 3 Factor。

> ...Using the Fama-French three-factor model with SMB premium 2% and HML premium 3%...

需要完全不同的公式。記憶化的模型會繼續套 CAPM，真正理解的模型才會切換公式。

#### I3 雜訊注入

**N1（無關數據）**：在原題中插入：

> The company was founded in 1987, has 12,500 employees, and received an ESG rating of AA from MSCI.

這些資訊跟 CAPM 計算完全無關。理性模型應忽略，但有些模型會被干擾。

**N4（矛盾資訊）**：

> The risk-free rate is 3%. *Note: Recent treasury data suggests the risk-free rate may have risen to 4.5%.*

兩個矛盾的利率值。模型需要判斷哪個是題目設定值。

---

## 實驗設計（實際執行）

| 項目 | 內容 |
|------|------|
| 測試集 | FinEval-CFA-Easy，100 題 |
| 模型 | GPT-4o-mini |
| I1 微擾 | Level 1（數值替換）+ Level 2（條件改變），由 GPT-4o-mini 生成 |
| I3 雜訊 | N1–N4 四種類型，每題各注入一種 |
| 統計檢定 | McNemar's test, Noise Sensitivity Index |

---

## 核心結果

### I1 反事實微擾

| 指標 | 數值 |
|------|------|
| Original Accuracy | 86.0% |
| Level 1 (數值替換) Accuracy | 62.5% (n_valid=64) |
| Level 2 (條件改變) Accuracy | 72.9% (n_valid=85) |
| **Memorization Gap (L1)** | **+23.5 pp** |
| Memorization Gap (L2) | +13.1 pp |
| **Robust Accuracy** | **58.0%** |
| Memorization Suspect Rate | 28.0% |

→ 標準準確率 86% 只是表面數字。換個數字就降到 62.5%，約 28% 的正確答案疑似來自記憶而非推理。**真正的穩健準確率只有 58%。**

### I3 雜訊敏感度

| 雜訊類型 | Accuracy | NSI | Flipped Questions |
|----------|----------|-----|-------------------|
| Clean (baseline) | 86.0% | -- | -- |
| N1 (無關數據) | 82.0% | 0.046 | 7/100 |
| N2 (誤導干擾) | 85.0% | 0.012 | 5/100 |
| N3 (冗餘上下文) | 85.0% | 0.012 | 3/100 |
| N4 (矛盾資訊) | 87.0% | −0.012 | 3/100 |

→ 雜訊敏感度相對溫和（max NSI=0.046）。GPT-4o-mini 的資訊過濾能力還算堪用。

### 關鍵發現

**主要漏洞是記憶化（23.5 pp gap），而非雜訊易感性（max 4.6 pp）。** 這意味著模型的核心問題不是「被干擾」，而是「根本沒在算」。

---

## 一句話總結

> **換個數字準確率就掉 23.5 pp，說明近三成的「正確答案」可能是背的不是算的。真正的穩健準確率只有 58%，遠低於表面的 86%。**

---

## 附錄

### 合併邏輯

I1 和 I3 都是「穩健性壓力測試」，但從互補角度切入：
- I1 改變 **signal**（題目本身的參數和條件）
- I3 添加 **noise**（題目之外的干擾資訊）

兩者合併形成完整的雙維度壓力測試框架，學術論點更完整。

### 實驗數據路徑

| 資料 | 路徑 |
|------|------|
| I1 完整結果 (N=100) | `experiments/I1_counterfactual/results/run_20260206_053445/results.json` |
| I3 完整結果 (N=100) | `experiments/I3_noise_red_herrings/results/run_20260206_054039/results.json` |

### 論文檔案結構

```
drafts/selected/I1_counterfactual/
├── main.tex                    # 完整論文 (17 pages)
├── main.pdf                    # 編譯 PDF
├── figures/
│   ├── fig1_accuracy_degradation.pdf
│   ├── fig2_noise_sensitivity.pdf
│   └── fig3_stress_test_framework.pdf
├── tables/
└── submission/
    └── cover_letter.tex
```
